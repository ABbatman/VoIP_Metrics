<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Call Metrics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="w-full mx-auto px-4">
    <h1 class="text-2xl font-bold mb-6">Monitoring by Burcovschi</h1>
    <!-- Filters Section -->
    <div class="w-full overflow-visible">
      <div class="flex items-center gap-2 w-full justify-start flex-nowrap overflow-visible max-w-full mx-auto px-2">

        <!-- Filter fields -->
        <input id="customerInput" placeholder="Customer" class="px-3 py-2 border rounded flex-grow min-w-0 basis-0 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 my-1" />
        
        <button
          id="reverseButton"
          onclick="toggleReverse()"
          title="Toggle direction"
          class="text-xl px-2 py-2 border rounded bg-gray-200 hover:bg-gray-300 active:bg-gray-400 my-1"
        >
          üîÅ
        </button>

        <input id="supplierInput" placeholder="Supplier" class="px-3 py-2 border rounded flex-grow min-w-0 basis-0 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 my-1" />
        <input id="destinationInput" placeholder="Destination" class="px-3 py-2 border rounded flex-grow min-w-0 basis-0 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 my-1" />
        <input id="fromDate" type="date" class="px-3 py-2 border rounded flex-grow min-w-0 basis-0 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 my-1" />

        <!-- From time -->
        <div class="flex flex-col flex-grow min-w-0 basis-0 my-1 relative">
            <input
                id="fromTime"
                type="time"
                step="1"
                class="px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                onfocus="showTimeControls('fromTimeControls')"
            />
            <div id="fromTimeControls" class="flex gap-1 hidden mt-1 absolute left-1/2 -translate-x-1/2 top-full z-10">
                <button onclick="adjustTime('fromTime', -1)" class="text-sm px-2 py-1 bg-gray-200 rounded">‚àí</button>
                <button onclick="setNow('fromTime')" class="text-sm px-2 py-1 bg-gray-200 rounded">N</button>
                <button onclick="setZero('fromTime')" class="text-sm px-2 py-1 bg-gray-200 rounded">Z</button>
                <button onclick="adjustTime('fromTime', 1)" class="text-sm px-2 py-1 bg-gray-200 rounded">+</button>
            </div>
        </div>

        <!-- To date -->
        <input id="toDate" type="date" class="px-3 py-2 border rounded flex-grow min-w-0 basis-0 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 my-1" />

        <!-- To time -->
        <div class="flex flex-col flex-grow min-w-0 basis-0 my-1 relative">
            <input
                id="toTime"
                type="time"
                step="1"
                class="px-3 py-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                onfocus="showTimeControls('toTimeControls')"
            />
            <div id="toTimeControls" class="flex gap-1 hidden mt-1 absolute left-1/2 -translate-x-1/2 top-full z-10">
                <button onclick="adjustTime('toTime', -1)" class="text-sm px-2 py-1 bg-gray-200 rounded">‚àí</button>
                <button onclick="setNow('toTime')" class="text-sm px-2 py-1 bg-gray-200 rounded">N</button>
                <button onclick="setZero('toTime')" class="text-sm px-2 py-1 bg-gray-200 rounded">Z</button>
                <button onclick="adjustTime('toTime', 1)" class="text-sm px-2 py-1 bg-gray-200 rounded">+</button>
            </div>
        </div>


        <!-- Buttons -->
        <button
          onclick="loadMetricsWithComparison(false)"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex-grow-0 flex-shrink-0 my-1"
        >
          Find
        </button>
        <button
          onclick="loadMetricsWithComparison(true)"
          class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800 flex-grow-0 flex-shrink-0 my-1"
        >
          Summary Table
        </button>
        <button class="bg-blue-800 text-white px-4 py-2 rounded hover:bg-blue-900 flex-grow-0 flex-shrink-0 my-1" title="Coming soon">CDR</button>
      </div>
    </div>

    <!-- Summary Table -->
    <div id="summaryTable" class="bg-white rounded shadow hidden w-full mt-6">
      <table class="w-full table-auto">
        <thead class="text-xs text-gray-800">
  <tr>
    <th id="thMain" class="px-2 py-2 text-left bg-gray-200 min-h-[24px]" rowspan="2">
  <div class="flex items-center gap-1 min-h-[20px]">
    Customer
    <button onclick="sortByColumn('customer')" class="text-xs text-blue-400 hover:text-blue-600" title="Sort by customer">‚¨ç</button>
  </div>
</th>

<th id="thPeer" class="px-2 py-2 text-left bg-gray-100 min-h-[24px]" rowspan="2">
  <div class="flex items-center gap-1 min-h-[20px]">
    Supplier
    <button onclick="sortByColumn('supplier')" class="text-xs text-blue-400 hover:text-blue-600" title="Sort by supplier">‚¨ç</button>
  </div>
</th>

<th class="px-2 py-1 text-left bg-gray-50" rowspan="2">
  <div class="flex items-center gap-1">
    Destination
    <button onclick="sortByColumn('destination')" class="text-xs text-blue-400 hover:text-blue-600" title="Sort by destination">‚¨ç</button>
  </div>
</th>

    <th class="px-2 py-1 text-center border-l bg-gray-100" colspan="3">Min</th>
    <th class="px-2 py-1 text-center border-l bg-[#eef1ec]" colspan="3">ACD</th>
    <th class="px-2 py-1 text-center border-l bg-[#eaf1f7]" colspan="3">ASR</th>
    <th class="px-2 py-1 text-center border-l bg-gray-100" colspan="3">SCall</th>
    <th class="px-2 py-1 text-center border-l bg-[#eef1ec]" colspan="3">TCall</th>

    <th class="px-2 py-1 text-center border-l-2 bg-[#eaf1f7]" colspan="3">PDD</th>
    <th class="px-2 py-1 text-center border-l bg-gray-100" colspan="3">ATime</th>
    <th class="px-2 py-1 text-center border-l bg-[#eef1ec]" colspan="3">ADur</th>
  </tr>
  <tr>
    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('Min')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort Min">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YMin')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YMin">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('MinPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort Min %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('ACD')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ACD">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YACD')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YACD">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('ACDPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ACD %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('ASR')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ASR">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YASR')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YASR">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('ASRPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ASR %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('SCall')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort SCall">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YSCall')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YSCall">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('SCallPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort SCall %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('TCall')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort TCall">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YTCall')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YTCall">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('TCallPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort TCall %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l-2 bg-white">
      Now <button onclick="sortByColumn('PDD')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort PDD">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YPDD')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YPDD">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('PDDPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort PDD %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('ATime')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ATime">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YATime')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YATime">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('ATimePct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ATime %">‚¨ç</button>
    </th>

    <th class="px-2 py-1 border-l bg-white">
      Now <button onclick="sortByColumn('ADur')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ADur">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-50">
      Y <button onclick="sortByColumn('YADur')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort YADur">‚¨ç</button>
    </th>
    <th class="px-2 py-1 bg-gray-100">
      % <button onclick="sortByColumn('ADurPct')" class="ml-1 text-xs text-blue-400 hover:text-blue-600" title="Sort ADur %">‚¨ç</button>
    </th>
  </tr>
</thead>
        <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

<script>

  let allSupplierData = [];

  // Merge current and yesterday metrics by customer + destination and calculate percentage change
  function mergeAndCompare(current, yesterday) {
  const yesterdayMap = {};
  yesterday.forEach(row => {
    const key = `${row.customer}|${row.destination}`;
    yesterdayMap[key] = row;
  });

  const merged = [];

  current.forEach(row => {
    const key = `${row.customer}|${row.destination}`;
    const yRow = yesterdayMap[key] || {};

    const makePct = (curr, prev) => {
      if (!prev || prev === 0) return 0;
      return +(((curr - prev) / prev) * 100).toFixed(1);
    };

    merged.push({
      customer: row.customer,
      supplier: row.supplier,
      destination: row.destination,

      Min: row.Min,
      YMin: yRow.Min || 0,
      MinPct: makePct(row.Min, yRow.Min),

      ACD: row.ACD,
      YACD: yRow.ACD || 0,
      ACDPct: makePct(row.ACD, yRow.ACD),

      ASR: row.ASR,
      YASR: yRow.ASR || 0,
      ASRPct: makePct(row.ASR, yRow.ASR),

      SCall: row.SCall,
      YSCall: yRow.SCall || 0,
      SCallPct: makePct(row.SCall, yRow.SCall),

      TCall: row.TCall,
      YTCall: yRow.TCall || 0,
      TCallPct: makePct(row.TCall, yRow.TCall),

      PDD: row.PDD,
      YPDD: yRow.PDD || 0,
      PDDPct: makePct(row.PDD, yRow.PDD),

      ATime: row.ATime,
      YATime: yRow.ATime || 0,
      ATimePct: makePct(row.ATime, yRow.ATime),

      ADur: row.ADur,
      YADur: yRow.ADur || 0,
      ADurPct: makePct(row.ADur, yRow.ADur)
    });
  });

  return merged;
}

// Group data (current or yesterday) by customer + destination
function groupByCustomerDestination(data) {
  const grouped = {};

  data.forEach(row => {
    const key = `${row.customer}|${row.destination}`;

    if (!grouped[key]) {
      grouped[key] = {
        customer: row.customer,
        destination: row.destination,
        seconds: 0,
        start_nuber: 0,
        start_attempt: 0,
        disc_reason: 0,
        pdd_total: 0,
        answer_time_total: 0,
        duration_total: 0,
        count: 0
      };
    }

    grouped[key].seconds += Number(row.seconds || 0);
    grouped[key].start_nuber += Number(row.start_nuber || 0);
    grouped[key].start_attempt += Number(row.start_attempt || 0);
    grouped[key].disc_reason += Number(row.disc_reason || 0);
    grouped[key].pdd_total += Number(row.pdd || 0);
    grouped[key].answer_time_total += Number(row.answer_time || 0);
    grouped[key].duration_total += Number(row.avg_duration || 0);
    grouped[key].count += 1;
  });

  // Convert grouped objects into array with calculated metrics
  const result = [];

  for (const key in grouped) {
    const g = grouped[key];

    result.push({
      customer: g.customer,
      destination: g.destination,
      Min: g.seconds ? Math.round(g.seconds / 60) : 0,
      ACD: g.start_nuber ? +((g.seconds / g.start_nuber / 60).toFixed(1)) : 0,
      ASR: g.start_attempt ? Math.round((g.start_nuber / g.start_attempt) * 100) : 0,
      SCall: g.start_nuber,
      TCall: g.start_attempt,
      PDD: g.count ? +(g.pdd_total / g.count / 1000).toFixed(1) : 0,
      ATime: g.count ? Math.round(g.answer_time_total / g.count) : 0,
      ADur: g.count ? +((g.duration_total / g.count / 60).toFixed(1)) : 0
    });
  }

  return result;
}

// Group by supplier + destination, and show each customer individually
function groupBySupplierDestinationCustomer(data) {
  const grouped = {};

  data.forEach(row => {
    const key = `${row.supplier}|${row.destination}|${row.customer}`;

    if (!grouped[key]) {
      grouped[key] = {
        supplier: row.supplier,
        customer: row.customer,
        destination: row.destination,
        seconds: 0,
        start_nuber: 0,
        start_attempt: 0,
        pdd_total: 0,
        answer_time_total: 0,
        duration_total: 0,
        count: 0
      };
    }

    grouped[key].seconds += Number(row.seconds || 0);
    grouped[key].start_nuber += Number(row.start_nuber || 0);
    grouped[key].start_attempt += Number(row.start_attempt || 0);
    grouped[key].pdd_total += Number(row.pdd || 0);
    grouped[key].answer_time_total += Number(row.answer_time || 0);
    grouped[key].duration_total += Number(row.avg_duration || 0);
    grouped[key].count += 1;
  });

  return Object.values(grouped).map(g => ({
    supplier: g.supplier,
    customer: g.customer,
    destination: g.destination,
    Min: g.seconds ? Math.round(g.seconds / 60) : 0,
    ACD: g.start_nuber ? +((g.seconds / g.start_nuber / 60).toFixed(1)) : 0,
    ASR: g.start_attempt ? Math.round((g.start_nuber / g.start_attempt) * 100) : 0,
    SCall: g.start_nuber,
    TCall: g.start_attempt,
    PDD: g.count ? +(g.pdd_total / g.count / 1000).toFixed(1) : 0,
    ATime: g.count ? Math.round(g.answer_time_total / g.count) : 0,
    ADur: g.count ? +((g.duration_total / g.count / 60).toFixed(1)) : 0
  }));
}

// Group data by supplier and destination
function groupBySupplierDestination(data) {
  const grouped = {};

  data.forEach(row => {
    const key = `${row.supplier}|${row.destination}`;

    // Initialize new group if not yet created
    if (!grouped[key]) {
      grouped[key] = {
        supplier: row.supplier,
        destination: row.destination,
        seconds: 0,
        start_nuber: 0,
        start_attempt: 0,
        pdd_total: 0,
        answer_time_total: 0,
        duration_total: 0,
        count: 0
      };
    }

    // Accumulate values for metrics
    grouped[key].seconds += Number(row.seconds || 0);
    grouped[key].start_nuber += Number(row.start_nuber || 0);
    grouped[key].start_attempt += Number(row.start_attempt || 0);
    grouped[key].pdd_total += Number(row.pdd || 0);
    grouped[key].answer_time_total += Number(row.answer_time || 0);
    grouped[key].duration_total += Number(row.avg_duration || 0);
    grouped[key].count += 1;
  });

  // Convert grouped data into final array with calculated metrics
  return Object.values(grouped).map(g => ({
    supplier: g.supplier,
    destination: g.destination,
    Min: g.seconds ? Math.round(g.seconds / 60) : 0,
    ACD: g.start_nuber ? +((g.seconds / g.start_nuber / 60).toFixed(1)) : 0,
    ASR: g.start_attempt ? Math.round((g.start_nuber / g.start_attempt) * 100) : 0,
    SCall: g.start_nuber,
    TCall: g.start_attempt,
    PDD: g.count ? +(g.pdd_total / g.count / 1000).toFixed(1) : 0,
    ATime: g.count ? Math.round(g.answer_time_total / g.count) : 0,
    ADur: g.count ? +((g.duration_total / g.count / 60).toFixed(1)) : 0
  }));
}

function loadMetricsWithComparison(showTable = false) {
  console.log("üü° reverseMode =", reverseMode);

  if (!showTable) {
    document.getElementById("summaryTable").classList.add("hidden");
  }

  const thMain = document.getElementById("thMain");
  const thPeer = document.getElementById("thPeer");

  if (reverseMode) {
    thMain.textContent = "Supplier";
    thPeer.textContent = "Customer";
  } else {
    thMain.textContent = "Customer";
    thPeer.textContent = "Supplier";
  }

  const customer = document.getElementById("customerInput").value.trim();
  const supplier = document.getElementById("supplierInput").value.trim();
  const destination = document.getElementById("destinationInput").value.trim();
  const from = document.getElementById("fromDate").value + 'T' + document.getElementById("fromTime").value;
  const to = document.getElementById("toDate").value + 'T' + document.getElementById("toTime").value;

  const fromDateObj = new Date(from);
  const toDateObj = new Date(to);
  const from_y = new Date(fromDateObj.getTime() - 24 * 60 * 60 * 1000).toISOString();
  const to_y = new Date(toDateObj.getTime() - 24 * 60 * 60 * 1000).toISOString();

  const paramsToday = new URLSearchParams({ customer, supplier, destination, from, to });
  const paramsYesterday = new URLSearchParams({ customer, supplier, destination, from: from_y, to: to_y });

  Promise.all([
    fetch(`/api/metrics?${paramsToday.toString()}`).then(res => res.json()),
    fetch(`/api/metrics?${paramsYesterday.toString()}`).then(res => res.json())
  ])
  .then(([current, yesterday]) => {
    allSupplierData = current;

    const groupedCurrent = reverseMode
      ? groupBySupplierDestination(current)
      : groupByCustomerDestination(current);

    const groupedYesterday = reverseMode
      ? groupBySupplierDestination(yesterday)
      : groupByCustomerDestination(yesterday);

    finalTable = mergeAndCompare(groupedCurrent, groupedYesterday);

    // Always render table
    renderTable();

    // Show the table if requested
    if (showTable) {
      document.getElementById("summaryTable").classList.remove("hidden");
    }
  })
  .catch(error => {
    console.error("Error loading metrics:", error);
  });
}
    
    // Store the final table data globally to reuse it for sorting
    let finalTable = [];

    // Track current sorting state
    let currentSort = {
      column: null,
      asc: true
    };

    // Sort finalTable by selected column and direction
    function sortByColumn(column) {
      // Do nothing if there is no data
      if (!finalTable.length) return;

      // Toggle sort direction if clicking the same column again
      if (currentSort.column === column) {
        currentSort.asc = !currentSort.asc;
      } else {
        currentSort.column = column;
        currentSort.asc = true;
      }

    // Perform sorting
    finalTable.sort((a, b) => {
      const valA = a[column];
      const valB = b[column];

      // Move null/undefined to the bottom
      if (valA == null) return 1;
      if (valB == null) return -1;

      // If numbers, do numeric sort
      if (typeof valA === "number" && typeof valB === "number") {
        return currentSort.asc ? valA - valB : valB - valA;
      }

      // Otherwise, do alphabetical sort
      return currentSort.asc
        ? String(valA).localeCompare(String(valB))
        : String(valB).localeCompare(String(valA));
    });
    renderTable();
  }
  

  function renderTable() {
  const table = document.getElementById("tableBody");
  table.innerHTML = "";
  // Loop through all rows and render them
  finalTable.forEach(row => {
      const main = reverseMode ? row.supplier : row.customer;
      const peer = reverseMode ? row.customer : row.supplier;

        table.innerHTML += `
          <tr class="hover:bg-gray-200 text-sm text-right">
            <td class="px-2 py-1 text-left">
              <button
                class="text-sm text-blue-600 hover:no-underline mr-1"
                data-main="${main}"
                data-destination="${row.destination}"
                onclick="toggleSuppliers(this)"
              >
                +
              </button>
              ${main}
            </td>

            <td class="px-2 py-1 text-left">${peer || ""}</td>
            <td class="px-2 py-1 text-left">${row.destination}</td>

            <td class="px-2 py-1 border-l">${row.Min}</td>
            <td class="px-2 py-1">${row.YMin != null ? row.YMin : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.MinPct != null ? row.MinPct : 0}</td>

            <td class="px-2 py-1 border-l">${row.ACD}</td>
            <td class="px-2 py-1">${row.YACD != null ? row.YACD : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.ACDPct != null ? row.ACDPct : 0}</td>

            <td class="px-2 py-1 border-l">${row.ASR}</td>
            <td class="px-2 py-1">${row.YASR != null ? row.YASR : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.ASRPct != null ? row.ASRPct : 0}</td>

            <td class="px-2 py-1 border-l">${row.SCall}</td>
            <td class="px-2 py-1">${row.YSCall != null ? row.YSCall : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.SCallPct != null ? row.SCallPct : 0}</td>

            <td class="px-2 py-1 border-l">${row.TCall}</td>
            <td class="px-2 py-1">${row.YTCall != null ? row.YTCall : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.TCallPct != null ? row.TCallPct : 0}</td>

            <td class="px-2 py-1 border-l-2">${row.PDD}</td>
            <td class="px-2 py-1">${row.YPDD != null ? row.YPDD : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.PDDPct != null ? row.PDDPct : 0}</td>

            <td class="px-2 py-1 border-l">${row.ATime}</td>
            <td class="px-2 py-1">${row.YATime != null ? row.YATime : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.ATimePct != null ? row.ATimePct : 0}</td>

            <td class="px-2 py-1 border-l">${row.ADur}</td>
            <td class="px-2 py-1">${row.YADur != null ? row.YADur : 0}</td>
            <td class="px-2 py-1 bg-gray-50">${row.ADurPct != null ? row.ADurPct : 0}</td>
          </tr>
        `;
      });

      // Make sure the table is visible
      document.getElementById("summaryTable").classList.remove("hidden");
    }

    function showTimeControls(id) {
      document.getElementById(id).classList.remove("hidden");
    }

    function hideTimeControls(id) {
      setTimeout(() => {
        document.getElementById(id).classList.add("hidden");
      }, 200);
    }

    function adjustTime(id, hoursDelta) {
      const timeInput = document.getElementById(id);
      const dateInput = document.getElementById(id === "fromTime" ? "fromDate" : "toDate");
      const currentDate = new Date(dateInput.value + 'T' + timeInput.value + 'Z');
      currentDate.setUTCHours(currentDate.getUTCHours() + hoursDelta);
      timeInput.value = currentDate.toISOString().substr(11, 8);
      dateInput.value = currentDate.toISOString().substr(0, 10);
    }

    function setNow(id) {
      const now = new Date();
      document.getElementById(id).value = now.toISOString().substr(11, 8);
      document.getElementById(id === "fromTime" ? "fromDate" : "toDate").value = now.toISOString().substr(0, 10);
    }

    function setZero(id) {
      document.getElementById(id).value = "00:00:00";
    }

    function setDefaultDateRange() {
      const now = new Date();
      const from = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      document.getElementById("fromDate").value = from.toISOString().slice(0, 10);
      document.getElementById("fromTime").value = from.toISOString().slice(11, 19);
      document.getElementById("toDate").value = now.toISOString().slice(0, 10);
      document.getElementById("toTime").value = now.toISOString().slice(11, 19);
    }

    function toggleSuppliers(button) {
      const main = button.dataset.main;
      const destination = button.dataset.destination;
      const currentRow = button.closest("tr");

      console.log("üîç Expand requested:");
      console.log("Mode:", reverseMode ? "Supplier ‚Üí Customers" : "Customer ‚Üí Suppliers");
      console.log("Main:", main, "Destination:", destination);

      // Collapse if already expanded
      let next = currentRow.nextElementSibling;
      let found = false;
      while (next && next.classList) {
        if (next.classList.contains("supplier-row")) {
          found = true;
          next.remove();
          next = currentRow.nextElementSibling;
        } else {
          break;
        }
      }

      if (found) {
        button.textContent = "+";
        return;
      }

      // Expand now
      button.textContent = "‚àí";

      // Filter data
      const filtered = reverseMode
        ? allSupplierData.filter(row =>
          row.supplier === main && row.destination === destination)
        : allSupplierData.filter(row =>
          row.customer === main && row.destination === destination);

      // Group filtered rows
      const grouped = reverseMode
        ? groupBySupplierDestinationCustomer(filtered)
        : groupByCustomerDestinationSupplier(filtered);

      // Debug output only
      console.log("Grouped rows:", grouped);

    // Render expandable rows
    const rowsHTML = grouped.map(s => {
      const name = reverseMode ? s.customer : s.supplier;

      return `
        <tr class="supplier-row bg-gray-100 hover:bg-gray-200 text-sm text-black text-right border-t border-dashed border-gray-300">
          <td></td>
          <td class="px-2 py-1 text-left">${name}</td>
          <td class="px-2 py-1 text-left">${s.destination}</td>

          <td class="px-2 py-1 border-l">${s.Min}</td>
          <td class="px-2 py-1">${s.YMin != null ? s.YMin : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.MinPct != null ? s.MinPct : 0}</td>

          <td class="px-2 py-1 border-l">${s.ACD}</td>
          <td class="px-2 py-1">${s.YACD != null ? s.YACD : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.ACDPct != null ? s.ACDPct : 0}</td>

          <td class="px-2 py-1 border-l">${s.ASR}</td>
          <td class="px-2 py-1">${s.YASR != null ? s.YASR : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.ASRPct != null ? s.ASRPct : 0}</td>

          <td class="px-2 py-1 border-l">${s.SCall}</td>
          <td class="px-2 py-1">${s.YSCall != null ? s.YSCall : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.SCallPct != null ? s.SCallPct : 0}</td>

          <td class="px-2 py-1 border-l">${s.TCall}</td>
          <td class="px-2 py-1">${s.YTCall != null ? s.YTCall : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.TCallPct != null ? s.TCallPct : 0}</td>

          <td class="px-2 py-1 border-l-2">${s.PDD}</td>
          <td class="px-2 py-1">${s.YPDD != null ? s.YPDD : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.PDDPct != null ? s.PDDPct : 0}</td>

          <td class="px-2 py-1 border-l">${s.ATime}</td>
          <td class="px-2 py-1">${s.YATime != null ? s.YATime : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.ATimePct != null ? s.ATimePct : 0}</td>

          <td class="px-2 py-1 border-l">${s.ADur}</td>
          <td class="px-2 py-1">${s.YADur != null ? s.YADur : 0}</td>
          <td class="px-2 py-1 bg-gray-50">${s.ADurPct != null ? s.ADurPct : 0}</td>
        </tr>
      `;
    }).join("");

    // Insert rows after the clicked row
    currentRow.insertAdjacentHTML("afterend", rowsHTML);
    }

  // Group data by customer + destination + supplier
  function groupByCustomerDestinationSupplier(data) {
    const grouped = {};
    data.forEach(row => {
      const key = `${row.customer}|${row.destination}|${row.supplier}`;
      if (!grouped[key]) {
        grouped[key] = {
          customer: row.customer,
          destination: row.destination,
          supplier: row.supplier,
          seconds: 0,
          start_nuber: 0,
          start_attempt: 0,
          pdd_total: 0,
          answer_time_total: 0,
          duration_total: 0,
          count: 0
        };
      }
      grouped[key].seconds += Number(row.seconds || 0);
      grouped[key].start_nuber += Number(row.start_nuber || 0);
      grouped[key].start_attempt += Number(row.start_attempt || 0);
      grouped[key].pdd_total += Number(row.pdd || 0);
      grouped[key].answer_time_total += Number(row.answer_time || 0);
      grouped[key].duration_total += Number(row.avg_duration || 0);
      grouped[key].count += 1;
    });

    return Object.values(grouped).map(g => ({
      customer: g.customer,
      supplier: g.supplier,
      destination: g.destination,

      Min: g.seconds ? Math.round(g.seconds / 60) : 0,
      ACD: g.start_nuber ? +((g.seconds / g.start_nuber / 60).toFixed(1)) : 0,
      ASR: g.start_attempt ? Math.round((g.start_nuber / g.start_attempt) * 100) : 0,
      SCall: g.start_nuber,
      TCall: g.start_attempt,
      PDD: g.count ? +(g.pdd_total / g.count / 1000).toFixed(1) : 0,
      ATime: g.count ? Math.round(g.answer_time_total / g.count) : 0,
      ADur: g.count ? +((g.duration_total / g.count / 60).toFixed(1)) : 0
    }));
  }

  let reverseMode = false;

  function toggleReverse() {
  reverseMode = !reverseMode;

  const button = document.getElementById("reverseButton");
    if (reverseMode) {
      button.classList.remove("bg-gray-200");
      button.classList.add("bg-gray-500", "text-white");
    } else {
      button.classList.remove("bg-gray-500", "text-white");
      button.classList.add("bg-gray-200");
    }
  }

    function loadMetrics(showTable = false) {
      const params = new URLSearchParams({
        customer: document.getElementById("customerInput").value.trim(),
        supplier: document.getElementById("supplierInput").value.trim(),
        destination: document.getElementById("destinationInput").value.trim(),
        from: document.getElementById("fromDate").value + 'T' + document.getElementById("fromTime").value,
        to: document.getElementById("toDate").value + 'T' + document.getElementById("toTime").value
      });



      fetch(`/api/metrics?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          const table = document.getElementById("tableBody");
          table.innerHTML = "";

          if (!Array.isArray(data) || data.length === 0) {
            table.innerHTML = `<tr><td colspan="7" class="px-4 py-2 text-gray-500">${Array.isArray(data) ? "No data found" : "Error loading data"}</td></tr>`;
            return;
          }

          data.forEach(row => {
            const acd = row.seconds && row.start_nuber ? (row.seconds / row.start_nuber).toFixed(1) : 0;
            const asr = row.start_attempt ? Math.round((row.start_nuber / row.start_attempt) * 100) : 0;
            const totalMin = Math.round(row.seconds / 60);

            table.innerHTML += `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">${row.time}</td>
                <td class="px-4 py-2">${row.customer}</td>
                <td class="px-4 py-2">${row.supplier}</td>
                <td class="px-4 py-2">${row.destination}</td>
                <td class="px-4 py-2">${acd}</td>
                <td class="px-4 py-2">${asr}%</td>
                <td class="px-4 py-2">${totalMin}</td>
              </tr>`;
          });

          if (showTable) {
            document.getElementById("summaryTable").classList.remove("hidden");
          }
        })
        .catch(error => {
          console.error("Fetch error:", error);
          document.getElementById("tableBody").innerHTML = `<tr><td colspan="7" class="text-red-600 px-4 py-2">Request failed</td></tr>`;
          });          


          // Auto-hide time control panels when clicking outside
          document.addEventListener("click", function (event) {
          const fromPanel = document.getElementById("fromTimeControls");
          const toPanel = document.getElementById("toTimeControls");
          const fromInput = document.getElementById("fromTime");
          const toInput = document.getElementById("toTime");

          const isClickInsideFrom = fromInput.contains(event.target) || fromPanel.contains(event.target);
          const isClickInsideTo = toInput.contains(event.target) || toPanel.contains(event.target);

          if (!isClickInsideFrom) fromPanel.classList.add("hidden");
          if (!isClickInsideTo) toPanel.classList.add("hidden");
          });
    }

    setDefaultDateRange();
    loadMetrics();
  </script>
</body>
</html>